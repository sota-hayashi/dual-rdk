# OOZ (Out-of-the-Zone) 判定手順

このファイルは，RT（反応時間）に基づいて Out-of-the-Zone（OOZ）状態を判定するための計算手順をまとめたものである．

---

## 前提と設計思想

OOZ 判定は以下の考え方に基づいて設計されている．

- 注意状態（attentional state）は trial-by-trial に変動する潜在変数である
- 学習指標（報酬・誤差）と同一試行の RT を直接用いると循環論が生じる
- 単に RT が速いだけでは「注意の途切れ」とは言えない

したがって，本手法では以下を基本原理とする．

- 現在試行の注意状態は，直前試行の情報から推定する
- RT の絶対値ではなく，個人内分布からの逸脱を重視する

---

# 修正対象ファイル

- `features/behavior.py`
- `features/lapses.py`
- `analysis/pipelines.py`

# 要求事項

## 1.以下のStep1~Step2の具体的に処理内容をそれぞれ`features/behavior.py`へ機能追加

- **関数名:** `calculate_rt_moving_mean`, `calculate_rt_deviance_mean`
- **引数:**
  - `concat_list: List[Tuple[str, pd.DataFrame]]`: 被験者番号とその被験者のデータフレームを格納したリスト

## 2.Step3の処理内容を`features/lapses.py`へ機能追加

- **関数名:** `label_if_ooz`
- **引数:** 
  - `concat_list: List[Tuple[str, pd.DataFrame]]`: 被験者番号とその被験者のデータフレームを格納したリスト

## 3.機能追加した関数を実行するコードを`analysis/pipellines.py`へ記入

# Step1: 直前試行 RT による注意状態の構成

## 目的

単一試行の RT は以下の要因により大きく変動する．

- バー初期位置や運動距離
- 偶発的な反応の速さ・遅さ
- 一時的な迷い・操作ミス

これらのノイズを含んだ RT をそのまま用いると，注意状態の推定が不安定になり，
同一試行内での循環論も生じる．

そのため，現在試行の注意状態は直前試行の情報のみから構成する．

## 計算方法

各試行 t に対して，直前 3 試行の RT の移動平均を計算する．

```
M_t = mean(RT_{t-1}, RT_{t-2}, RT_{t-3})
```

- ブロック冒頭などで 3 試行に満たない場合は利用可能な試行のみで平均を取る
- 実装上は rolling mean として扱う

## 解釈

- M_t は試行 t の反応そのものではない
- 直前までの注意状態（state）の proxy として機能する

---

# Step2: RT の外れ度（deviance）の定義

## 目的

RT が速い理由には少なくとも以下の 2 種類が存在する．

- 課題への熟練や効率化による正当な高速化
- 注意が抜けたことによる衝動的反応

単純な RT の大小では，これらを区別できない．

そこで，その被験者自身の RT 分布からどれだけ逸脱しているかを定量化する．

## 計算方法

被験者ごとに RT の平均を計算する．

```
RT_mean = mean(RT)
```

各試行について，平均からの絶対偏差を計算する．

```
D_t = |RT_t - RT_mean|
```

さらに，Step1 と同様に直前 3 試行で平滑化する．

```
D_t_smooth = mean(D_{t-1}, D_{t-2}, D_{t-3})
```

## 解釈

- D_t は速い・遅いを直接表す指標ではない
- その人にとってどれだけ非典型的かを表す

この処理により，全体的に RT が速い被験者・遅い被験者を同一基準で評価できる．

---

# Step3: OOZ (Out-of-the-Zone) の判定

## 目的

OOZ を以下の状態として定義する．

- 最近の反応が速い
- かつ，その速さが個人内分布から見て異常である

すなわち，速い × 異常 の論理積によって OOZ を判定する．

## 計算方法

### 条件1: 直前の注意状態が速い

被験者ごとに M_t の平均を計算する．

```
M_mean = mean(M_t)
```

以下を満たすかを判定する．

```
M_t < M_mean
```

これは「最近の反応が，その人の通常より速い」ことを意味する．

### 条件2: RT の外れ度が大きい

被験者ごとに D_t_smooth の中央値を計算する．

```
m_i = median(D_t_smooth)
```

次に，参加者全体でその平均を取り，group threshold を定義する．

```
T = mean(m_i)
```

各試行について，以下を判定する．

```
D_t_smooth > T
```

### 最終的な OOZ 判定

試行 t が OOZ である条件は以下である．

```
OOZ(t) = True if
    (M_t < M_mean) and
    (D_t_smooth > T)
```

## 解釈

- 条件1により単なる遅延試行を除外する
- 条件2により熟練による高速化を除外する

この 2 条件により，注意が途切れた衝動的状態のみを OOZ として抽出できる．

---

# 実装上の注意

- RT は事前に以下の前処理を行うことが望ましい
  - 極端に遅い試行の除外
  - trial number によるドリフト補正
- バー初期位置が RT に影響する課題では
  - 初期角距離 Δθ で RT を回帰補正した残差を用いる

---

この手順により，OOZ 判定は学習指標と独立した注意状態の定量化として定義される．
